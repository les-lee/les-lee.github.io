<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>全方位的,零死角的,分析tapable源码 | Les Lee’s 空间</title>
    <meta name="description" content="对所有热爱分享的技术人致敬">
    <link rel="icon" href="/rong.ico">
    
    <link rel="preload" href="/assets/css/0.styles.1bd162e4.css" as="style"><link rel="preload" href="/assets/js/app.1e3fcec8.js" as="script"><link rel="preload" href="/assets/js/10.8edc7d77.js" as="script"><link rel="preload" href="/assets/js/2.4778334a.js" as="script"><link rel="preload" href="/assets/js/1.cb8c6553.js" as="script"><link rel="preload" href="/assets/js/19.4691e707.js" as="script"><link rel="prefetch" href="/assets/js/11.9b2ccf7d.js"><link rel="prefetch" href="/assets/js/12.c73d23a3.js"><link rel="prefetch" href="/assets/js/13.6996d9b6.js"><link rel="prefetch" href="/assets/js/14.690232a6.js"><link rel="prefetch" href="/assets/js/15.7fdd7888.js"><link rel="prefetch" href="/assets/js/16.aeb0dce5.js"><link rel="prefetch" href="/assets/js/17.4f336f3a.js"><link rel="prefetch" href="/assets/js/18.d097025e.js"><link rel="prefetch" href="/assets/js/20.fe97bc37.js"><link rel="prefetch" href="/assets/js/21.6b8ec638.js"><link rel="prefetch" href="/assets/js/22.56a9c4a6.js"><link rel="prefetch" href="/assets/js/23.1bf8280a.js"><link rel="prefetch" href="/assets/js/4.1a9dfd88.js"><link rel="prefetch" href="/assets/js/5.b2c70424.js"><link rel="prefetch" href="/assets/js/6.7d076122.js"><link rel="prefetch" href="/assets/js/7.cfcb810d.js"><link rel="prefetch" href="/assets/js/8.d192495b.js"><link rel="prefetch" href="/assets/js/9.ed417c86.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1bd162e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Les Lee’s 空间</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">js</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link router-link-active">webpack</a></li><li class="dropdown-item"><!----> <a href="/translate/" class="nav-link">翻译</a></li></ul></div></div><div class="nav-item"><a href="https://segmentfault.com/blog/les-lee" target="_blank" rel="noopener noreferrer" class="nav-link external">
  To segmentfalut
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/5b15d5265188251360238c35/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  To 掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/les-lee" target="_blank" rel="noopener noreferrer" class="nav-link external">
  To GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/webpack/contact.html" class="nav-link">联系我(请备注来处)</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">js</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link router-link-active">webpack</a></li><li class="dropdown-item"><!----> <a href="/translate/" class="nav-link">翻译</a></li></ul></div></div><div class="nav-item"><a href="https://segmentfault.com/blog/les-lee" target="_blank" rel="noopener noreferrer" class="nav-link external">
  To segmentfalut
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/5b15d5265188251360238c35/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  To 掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/les-lee" target="_blank" rel="noopener noreferrer" class="nav-link external">
  To GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/webpack/contact.html" class="nav-link">联系我(请备注来处)</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>全方位的,零死角的,分析tapable源码</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/webpack/tapable.html#tap" class="sidebar-link">tap</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#new-synchook-synchook" class="sidebar-link">new SyncHook(['synchook'])</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#第二步-tap" class="sidebar-link">第二步 .tap()</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#发布订阅模式" class="sidebar-link">发布订阅模式</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#createcompiledelegate-name-type" class="sidebar-link">createCompileDelegate(name, type)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#createcall" class="sidebar-link">_createCall()</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#现在可以来看一下setup了" class="sidebar-link">现在可以来看一下setup了</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#现在我们来看看header" class="sidebar-link">现在我们来看看header()</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#参数搞明白了-现在-我们可以进入calltap-了" class="sidebar-link">参数搞明白了,现在,我们可以进入callTap() 了</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/webpack/tapable.html#后记" class="sidebar-link">后记</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content default"><h1 id="全方位的-零死角的-分析tapable源码"><a href="#全方位的-零死角的-分析tapable源码" aria-hidden="true" class="header-anchor">#</a> 全方位的,零死角的,分析tapable源码</h1> <p>上一遍博文中,我们谈到了tapable的用法,现在我们来深入一下tap究竟是怎么运行的, 怎么处理,控制 tap 进去的钩子函数,拦截器又是怎么运行的.</p> <p>俺们先从同步函数说起,再扩展到异步.</p> <h2 id="tap"><a href="#tap" aria-hidden="true" class="header-anchor">#</a> tap</h2> <p>这里有一个例子</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> SyncHook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/SyncHook.js'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> h1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'options'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

h1<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'b'</span><span class="token punctuation">;</span> <span class="token comment">// 除非你在拦截器上的 register 上调用这个函数,不然这个返回值你拿不到.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

h1<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
h1<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
h1<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

h1<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  call<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> <span class="token string">'-------------intercept call'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//</span>
  register<span class="token punctuation">:</span> <span class="token punctuation">(</span>tap<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tap<span class="token punctuation">,</span> <span class="token string">'------------------intercept register'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> tap<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  loop<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> <span class="token string">'-------------intercept loop'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  tap<span class="token punctuation">:</span> <span class="token punctuation">(</span>tap<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tap<span class="token punctuation">,</span> <span class="token string">'-------------------intercept tap'</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
h1<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="new-synchook-synchook"><a href="#new-synchook-synchook" aria-hidden="true" class="header-anchor">#</a> <code>new SyncHook(['synchook'])</code></h2> <p>首先先创建一个同步钩子对象,那这一步会干什么呢?</p> <p>这一步会先执行超类Hook的初始化工作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 初始化</span>
<span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 参数必须是数组</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 把数组参数赋值给 _args 内部属性, new 的时候传进来的一系列参数.</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>
  <span class="token comment">// 绑定taps,应该是事件</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 拦截器数组</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 暴露出去用于调用同步钩子的函数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>
  <span class="token comment">// 暴露出去的用于调用异步promise函数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_promise<span class="token punctuation">;</span>
  <span class="token comment">// 暴露出去的用于调用异步钩子函数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>callAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_callAsync<span class="token punctuation">;</span>
  <span class="token comment">// 用于生存调用函数的时候,保存钩子数组的变量,现在暂时先不管.</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="第二步-tap"><a href="#第二步-tap" aria-hidden="true" class="header-anchor">#</a> 第二步 <code>.tap()</code></h2> <p>现在我们来看看调用了tap() 方法后发生了什么</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">tap</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 下面是一些参数的限制,第一个参数必须是字符串或者是带name属性的对象,</span>
  <span class="token comment">// 用于标明钩子,并把钩子和名字都整合到 options 对象里面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> options <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Invalid arguments to tap(options: Object, fn: function)&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Missing name for tap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册拦截器</span>
  options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 插入钩子</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>现在我们来看看如何注册拦截器</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 现在这个参数应该是这个样子的{fn: function..., type: sync,name: 'A' }</span>
<span class="token comment">// 遍历拦截器,有就应用,没有就把配置返还回去</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> interceptor <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>register<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 把选项传入拦截器注册,从这里可以看出,拦截器的register 可以返回一个新的options选项,并且替换掉原来的options选项,也就是说可以在执行了一次register之后 改变你当初 tap 进去的方法</span>
    <span class="token keyword">const</span> newOptions <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newOptions <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> options <span class="token operator">=</span> newOptions<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> options<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>注意</strong>: 这里执行的register拦截器是有顺序问题的, 这个执行在tap()里面,也就是说,你这个拦截器要在调用tap(),之前就调用 intercept()添加的.</p> <p>那拦截器是怎么添加进去的呢,来看下intercept()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">intercept</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 重置所有的 调用 方法,在教程中我们提到了 编译出来的调用方法依赖的其中一点就是 拦截器. 所有每添加一个拦截器都要重置一次调用方法,在下一次编译的时候,重新生成.</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 保存拦截器 而且是复制一份,保留原本的引用</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 运行所有的拦截器的register函数并且把 taps[i],(tap对象) 传进去.</span>
  <span class="token comment">// 在intercept 的时候也会遍历执行一次当前所有的taps,把他们作为参数调用拦截器的register,并且把返回的 tap对象(tap对象就是指 tap函数里面把fn和name这些信息整合起来的那个对象) 替换了原来的 tap对象,所以register最好返回一个tap, 在例子中我返回了原来的tap, 但是其实最好返回一个全新的tap</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>register<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>注意</strong>: 也就是在调用tap() 之后再传入的拦截器,会在传入的时候就为每一个tap 调用register方法</p> <ul><li>现在我们来看看_insert</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_insert</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 重置资源,因为每一个插件都会有一个新的Compilation</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 顺序标记, 这里联合 __test__ 包里的Hook.js一起使用</span>
  <span class="token comment">// 看源码不懂,可以看他的测试代码,就知道他写的是什么目的.</span>
  <span class="token comment">// 从测试代码可以看到,这个 {before}是插件的名字.</span>
  <span class="token keyword">let</span> before<span class="token punctuation">;</span>
  <span class="token comment">// before 可以是单个字符串插件名称,也可以是一个字符串数组插件.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>before <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">.</span>before<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 阶段</span>
  <span class="token comment">// 从测试代码可以知道这个也是一个控制顺序的属性,值越小,执行得就越在前面</span>
  <span class="token comment">// 而且优先级低于 before</span>
  <span class="token keyword">let</span> stage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>stage <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> stage <span class="token operator">=</span> item<span class="token punctuation">.</span>stage<span class="token punctuation">;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token comment">// 遍历所有`tap`了的函数,然后根据 stage 和 before 进行重新排序.</span>
  <span class="token comment">// 假设现在tap了 两个钩子  A B  `B` 的配置是  {name: 'B', before: 'A'}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// i = 1, taps = [A]</span>
    i<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">// i = 0 首先-- 是因为要从最后一个开始</span>
    <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// x = A</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span><span class="token comment">// i = 0, taps[1] = A  i+1 把当前元素往后移位,把位置让出来</span>
    <span class="token keyword">const</span> xStage <span class="token operator">=</span> x<span class="token punctuation">.</span>stage <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// xStage = 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果有这个属性就会进入这个判断</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果before 有x.name 就会把这个插件名称从before这个列表里删除,代表这个钩子位置已经在当前的钩子之前</span>
        before<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">// 如果before还有元素,继续循环,执行上面的操作</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">// 如果before还有元素,那就一直循环,直到第一位.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xStage <span class="token operator">&gt;</span> stage<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果stage比当前钩子的stage大,继续往前挪</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span><span class="token comment">// 把挪出来的位置插入传进来的钩子</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>这其实就是一个排序算法, 根据before, stage 的值来排序,也就是说你可以这样tap进来一个插件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>h1<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'B'</span><span class="token punctuation">,</span>
  before<span class="token punctuation">:</span> <span class="token string">'A'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i am B'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="发布订阅模式"><a href="#发布订阅模式" aria-hidden="true" class="header-anchor">#</a> 发布订阅模式</h2> <p>发布订阅模式是一个在前后端都盛行的一个模式,前端的promise,事件,等等都基于发布订阅模式,其实tapable 也是一种发布订阅模式,上面的tap 只是订阅了钩子函数,我们还需要发布他,接下来我们谈谈<code>h1.call()</code>,跟紧了,这里面才是重点.</p> <p>我们可以在初始化中看到<code>this.call = this._call</code>,那我们来看一下 this._call() 是个啥</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>Hook<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  _call<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;call&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  _promise<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;promise&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  _callAsync<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;callAsync&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>结果很明显,这个函数是由createCompileDelegate(),这个函数返回的,依赖于,函数的名字以及钩子的类型.</p> <h2 id="createcompiledelegate-name-type"><a href="#createcompiledelegate-name-type" aria-hidden="true" class="header-anchor">#</a> <code>createCompileDelegate(name, type)</code></h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">lazyCompileHook</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 子类调用时,this默认绑定到子类</span>
    <span class="token comment">// (不明白的可以了解js this指向,一个函数的this指向调用他的对象,没有就是全局,除非使用call apply bind 等改变指向)</span>
    <span class="token comment">// 在我们的例子中,这个 this 是 SyncHook</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用args 去调用Call</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在上面的注释上可以加到,他通过闭包保存了<code>name</code>跟<code>type</code>的值,在我们这个例子中,这里就是<code>this.call = this._createCall('sync');</code>然后把我们外部调用call(666) 时 传入的参数给到他编译生成的方法中.</p> <p><strong>注意</strong>,在我们这个例子当中我在call的时候并没有传入参数.</p> <p>这时候这个<code>call</code>方法的重点就在<code>_createCall</code>方法里面了.</p> <h2 id="createcall"><a href="#createcall" aria-hidden="true" class="header-anchor">#</a> _createCall()</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_createCall</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 传递一个整合了各个依赖条件的对象给子类的compile方法</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    taps<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
    interceptors<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>
    args<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> type
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>从一开始,我们就在Hook.js上分析,我们来看看Hook上的compile</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">compile</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Abstract: should be overriden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>清晰明了,这个方法一定要子类复写,不然报错,上面的<code>_createCompileDelegate</code>的注释也写得很清楚,在当前的上下文中,this指向的是,子类,在我们这个例子中就是<code>SyncHook</code></p> <p>来看看<code>SyncHook</code> 的compile</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">compile</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 现在options 是由Hook里面 传到这里的</span>
  <span class="token comment">// options</span>
  <span class="token comment">// {</span>
  <span class="token comment">//  taps: this.taps, tap对象数组</span>
  <span class="token comment">//  interceptors: this.interceptors, 拦截器数组</span>
  <span class="token comment">//  args: this._args,</span>
  <span class="token comment">//  type: type</span>
  <span class="token comment">// }</span>
  <span class="token comment">// 对应回教程中的编译出来的调用函数依赖于的那几项看看,是不是这些,钩子的个数,new SyncHook(['arg'])的参数个数,拦截器的个数,钩子的类型.</span>
  factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>好吧 现在来看看setup, 咦? factory 怎么来的,原来</p> <p><code>const factory = new SyncHookCodeFactory();</code></p> <p>是new 出来的,现在来看看SyncHookCodeFactory 的父类 HookCodeFactory</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 这个config作用暂定.因为我看了这个文件,没看到有引用的地方,</span>
  <span class="token comment">// 应该是其他子类有引用到</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
  <span class="token comment">// 这两个不难懂, 往下看就知道了</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="现在可以来看一下setup了"><a href="#现在可以来看一下setup了" aria-hidden="true" class="header-anchor">#</a> 现在可以来看一下setup了</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">setup</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里的instance 是syncHook 实例, 其实就是把tap进来的钩子数组给到钩子的_x属性里.</span>
  instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>OK, 到create了</p> <p>这个create有点长, 看仔细了,我们现在分析同步的部分.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化参数,保存options到本对象this.options,保存new Hook([&quot;options&quot;]) 传入的参数到 this._args</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> fn<span class="token punctuation">;</span>
  <span class="token comment">// 动态构建钩子,这里是抽象层,分同步, 异步, promise</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先看同步</span>
    <span class="token keyword">case</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">:</span>
      <span class="token comment">// 动态返回一个钩子函数</span>
      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
        <span class="token comment">// 生成函数的参数,no before no after 返回参数字符串 xxx,xxx 在</span>
        <span class="token comment">// 注意这里this.args返回的是一个字符串,</span>
        <span class="token comment">// 在这个例子中是options</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
            onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
            onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            rethrowIfPossible<span class="token punctuation">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">:</span>
      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          after<span class="token punctuation">:</span> <span class="token string">&quot;_callback&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          <span class="token comment">// 这个 content 调用的是子类类的 content 函数,</span>
          <span class="token comment">// 参数由子类传,实际返回的是 this.callTapsSeries() 返回的类容</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`_callback(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">,</span>
            onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`_callback(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">,</span>
            onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;_callback();\n&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">:</span>
      <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token string">'&quot;use strict&quot;;\n'</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token string">&quot;return new Promise((_resolve, _reject) =&gt; {\n&quot;</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token string">&quot;var _sync = true;\n&quot;</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
          code <span class="token operator">+=</span> <span class="token string">&quot;if(_sync)\n&quot;</span><span class="token punctuation">;</span>
          code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`_resolve(Promise.resolve().then(() =&gt; { throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; }));\n`</span></span><span class="token punctuation">;</span>
          code <span class="token operator">+=</span> <span class="token string">&quot;else\n&quot;</span><span class="token punctuation">;</span>
          code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`_reject(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> code<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`_resolve(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">,</span>
        onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;_resolve();\n&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token string">&quot;_sync = false;\n&quot;</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token string">&quot;});\n&quot;</span><span class="token punctuation">;</span>
      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 把刚才init赋的值初始化为undefined</span>
  <span class="token comment">// this.options = undefined;</span>
  <span class="token comment">// this._args = undefined;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>到了这个方法,一切我们都一目了然了(看content的参数), 在我们的例子中他是通过动态的生成一个call方法,根据的条件有,钩子是否有context 属性(这个是根据header的代码才能知道), 钩子的个数, 钩子的类型,钩子的参数,钩子的拦截器个数.</p> <p><strong>注意</strong>,这上面有关于 fn这个变量的函数,返回的都是字符串,不是函数不是方法,是返回可以转化成代码执行的字符串,思维要转变过来.</p> <h2 id="现在我们来看看header"><a href="#现在我们来看看header" aria-hidden="true" class="header-anchor">#</a> 现在我们来看看header()</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// this.needContext() 判断taps[i] 是否 有context 属性, 任意一个tap有 都会返回 true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">needContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果有context 属性, 那_context这个变量就是一个空的对象.</span>
    code <span class="token operator">+=</span> <span class="token string">&quot;var _context = {};\n&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则 就是undefined</span>
    code <span class="token operator">+=</span> <span class="token string">&quot;var _context;\n&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 在setup()中 把所有tap对象的钩子 都给到了 instance ,这里的this 就是setup 中的instance _x 就是钩子对象数组</span>
  code <span class="token operator">+=</span> <span class="token string">&quot;var _x = this._x;\n&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果有拦截器,在我们的例子中,就有一个拦截器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存taps 数组到_taps变量, 保存拦截器数组 到变量_interceptors</span>
    code <span class="token operator">+=</span> <span class="token string">&quot;var _taps = this.taps;\n&quot;</span><span class="token punctuation">;</span>
    code <span class="token operator">+=</span> <span class="token string">&quot;var _interceptors = this.interceptors;\n&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果没有拦截器, 这里也不会执行.一个拦截器只会生成一次call</span>
  <span class="token comment">// 在我们的例子中,就有一个拦截器,就有call</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> interceptor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>interceptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// getInterceptor 返回的 是字符串 是 `_interceptors[i]`</span>
      <span class="token comment">// 后面的before 因为我们的拦截器没有context 所以返回的是undefined 所以后面没有跟一个空对象</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInterceptor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.call(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        before<span class="token punctuation">:</span> interceptor<span class="token punctuation">.</span>context <span class="token operator">?</span> <span class="token string">&quot;_context&quot;</span> <span class="token punctuation">:</span> undefined
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)});\n`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> code<span class="token punctuation">;</span>
  <span class="token comment">// 注意 header 返回的不是代码,是可以转化成代码的字符串(这个时候并没有执行).</span>
  <span class="token comment">/**
    * 此时call函数应该为:
    * &quot;use strict&quot;;
    * function (options) {
    *   var _context;
    *   var _x = this._x;
    *   var _taps = this.taps;
    *   var _interterceptors = this.interceptors;
    * // 我们只有一个拦截器所以下面的只会生成一个
    *   _interceptors[0].call(options);
    *}
    */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>现在到我们的<code>this.content()</code>了,仔细一看,<code>this.content()</code>方法并不在<code>HookCodeFactory</code>上,很明显这个content是由子类来实现的,往回看看这个create是由谁调用的?没错,是SuncHookCodeFactory的石料理,我们来看看<code>SyncHook.js</code>上的<code>SyncHookCodeFactory</code>实现的<code>content</code></p> <p>在看这个content实现之前,先来回顾一下父类的<code>create()</code>给他传了什么参数.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
  onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
  onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  rethrowIfPossible<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>注意了,这上面不是抛出错误,不是返回值. 这里面的回调执行了以后返回的是一个字符串,不要搞混了代码与可以转化成代码的字符串.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 可以在这改变onError 但是这里的 i 并没有用到,这是什么操作...</span>
    <span class="token comment">// 注意这里并没有传入onResult</span>
    onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
    onDone<span class="token punctuation">,</span>
    <span class="token comment">// 这个默认为true</span>
    rethrowIfPossible
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这个函数返回什么取决于this.callTapSeries(), 那接下来我们来看看这个函数(这层层嵌套,其实也是有可斟酌的地方.看源码不仅要看实现,代码的组织也是很重要的编码能力)</p> <p>刚才函数的头部已经出来了,头部做了初始化的操作,与生成执行拦截器代码.content很明显,要开始生成执行我们的tap对象的代码了(如果不然,我们的tap进来的函数在哪里执行呢? 滑稽:).</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果 taps 钩子处理完毕,执行onDone,或者一个tap都没有 onDone() 返回的是一个字符串.看上面的回顾就知道了.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果由异步钩子,把第一个异步钩子的下标,如果没有这个返回的是-1</span>
  <span class="token keyword">const</span> firstAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 定义一个函数 接受一个 number 类型的参数, i 应该是taps的index</span>
  <span class="token comment">// 从这个函数的命名来看,这个函数应该会递归的执行</span>
  <span class="token comment">// 我们先开最后的return语句,发现第一个传进来的参数是0</span>
  <span class="token keyword">const</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> i <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 大于等于钩子函数数组长度, 返回并执行onDone回调,就是tap对象都处理完了</span>
    <span class="token comment">// 跳出递归的条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这个方法就是递归的关键,看见没,逐渐往上遍历</span>
    <span class="token comment">// 注意这里只是定义了方法,并没有执行</span>
    <span class="token keyword">const</span> <span class="token function-variable function">done</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 传入一个值 如果是false 就执行onDone true 返回一个 &quot;&quot;</span>
    <span class="token comment">// 字面意思,是否跳过done 应该是增加一个跳出递归的条件</span>
    <span class="token keyword">const</span> <span class="token function-variable function">doneBreak</span> <span class="token operator">=</span> skipDone <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>skipDone<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里就是处理单个taps对象的关键,传入一个下标,和一系列回调.</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用的onError 是 (i, err) =&gt; onError(err) , 后面这个onError(err)是 () =&gt; `throw ${err}`</span>
      <span class="token comment">// 目前 i done doneBreak 都没有用到</span>
      onError<span class="token punctuation">:</span> error <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> error<span class="token punctuation">,</span> done<span class="token punctuation">,</span> doneBreak<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 这里onResult 同步钩子的情况下在外部是没有传进来的,刚才也提到了</span>
      <span class="token comment">// 这里onResult是 undefined</span>
      onResult<span class="token punctuation">:</span>
        onResult <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>result <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">onResult</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> result<span class="token punctuation">,</span> done<span class="token punctuation">,</span> doneBreak<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 没有onResult 一定要有一个onDone 所以这里就是一个默认的完成回调</span>
      <span class="token comment">// 这里的done 执行的是next(i+1), 也就是迭代的处理完所有的taps</span>
      onDone<span class="token punctuation">:</span>
        <span class="token operator">!</span>onResult <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// rethrowIfPossible 默认是 true 也就是返回后面的</span>
      <span class="token comment">// 因为没有异步函数 firstAsync = -1.</span>
      <span class="token comment">// 所以返回的是 -1 &lt; 0,也就是true, 这个可以判断当前的是否是异步的tap对象</span>
      <span class="token comment">//  这里挺妙的 如果是 false 那么当前的钩子类型就不是sync,可能是promise或者是async</span>
      <span class="token comment">// 具体作用要看callTaps()如何使用这个.</span>
      rethrowIfPossible<span class="token punctuation">:</span>
        rethrowIfPossible <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>firstAsync <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">&lt;</span> firstAsync<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h2 id="参数搞明白了-现在-我们可以进入calltap-了"><a href="#参数搞明白了-现在-我们可以进入calltap-了" aria-hidden="true" class="header-anchor">#</a> 参数搞明白了,现在,我们可以进入<code>callTap()</code> 了</h2> <p><code>callTap</code>挺长的,因为他也分了3种类型分别处理,想create()一样.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/** tapIndex 下标
  * onError:() =&gt; onError(i,err,done,skipdone) ,
  * onReslt: undefined
  * onDone: () =&gt; {return: done()} //开启递归的钥匙
  * rethrowIfPossible: false 说明当前的钩子不是sync的.
  */</span>
<span class="token function">callTap</span><span class="token punctuation">(</span>tapIndex<span class="token punctuation">,</span> <span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// hasTapCached 是否有tap的缓存, 这个要看看他是怎么做的缓存了</span>
  <span class="token keyword">let</span> hasTapCached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 这里还是拦截器的用法,如果有就执行拦截器的tap函数</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> interceptor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>interceptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>tap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasTapCached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里getTap返回的是 _taps[0] _taps[1]... 的字符串</span>
        <span class="token comment">// 这里生成的代码就是 `var _tap0 = _taps[0]`</span>
        <span class="token comment">// 注意: _taps 变量我们在 header 那里已经生成了</span>
        code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`var _tap</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTap</span><span class="token punctuation">(</span>tapIndex<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">;</span>
        <span class="token comment">// 可以看到这个变量的作用就是,如果有多个拦截器.这里也只会执行一次.</span>
        <span class="token comment">// 注意这句获取_taps 对象的下标用的是tapIndex,在一次循环中,这个tapIndex不会变</span>
        <span class="token comment">// 就是说如果这里执行多次,就会生成多个重复代码,不稳定,也影响性能.</span>
        <span class="token comment">// 但是你又要判断拦截器有没有tap才可以执行,或许有更好的写法</span>
        <span class="token comment">// 如果你能想到,那么你就是webpack的贡献者了.不过这样写,似乎也没什么不好.</span>
        hasTapCached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 这里很明显跟上面的getTap 一样 返回的都是字符串</span>
      <span class="token comment">// 我就直接把这里的code 分析出来了,注意 这里还是在循坏中.</span>
      <span class="token comment">// code += _interceptor[0].tap(_tap0);</span>
      <span class="token comment">// 由于我们的拦截器没有context,所以没传_context进来.</span>
      <span class="token comment">// 可以看到这里是调用拦截器的tap方法然后传入tap0对象的地方</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInterceptor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.tap(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        interceptor<span class="token punctuation">.</span>context <span class="token operator">?</span> <span class="token string">&quot;_context, &quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_tap</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 跑出了循坏</span>
  <span class="token comment">// 这里的getTapFn 返回的也是字符串 `_x[0]`</span>
  <span class="token comment">// callTap用到的这些全部在header() 那里生成了,忘记的回头看一下.</span>
  <span class="token comment">// 这里的code就是: var _fn0 = _x[0]</span>
  code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`var _fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTapFn</span><span class="token punctuation">(</span>tapIndex<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">[</span>tapIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 开始处理tap 对象</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>tap<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">:</span>
      <span class="token comment">// 全是同步的时候, 这里不执行, 如果有异步函数,那么恭喜,有可能会报错.所以他加了个 try...catch</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rethrowIfPossible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`var _hasError</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = false;\n`</span></span><span class="token punctuation">;</span>
        code <span class="token operator">+=</span> <span class="token string">&quot;try {\n&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 前面分析了 同步的时候 onResult 是 undefined</span>
      <span class="token comment">// 我们也分析一下如果走这里会怎样</span>
      <span class="token comment">// var _result0 = _fn0(option)</span>
      <span class="token comment">// 可以看到是调用tap 进来的钩子并且接收参数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`var _result</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = _fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          before<span class="token punctuation">:</span> tap<span class="token punctuation">.</span>context <span class="token operator">?</span> <span class="token string">&quot;_context&quot;</span> <span class="token punctuation">:</span> undefined
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)});\n`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 所以会走这里</span>
        <span class="token comment">// _fn0(options) 额... 我日 有就接受一下结果</span>
        code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`_fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          before<span class="token punctuation">:</span> tap<span class="token punctuation">.</span>context <span class="token operator">?</span> <span class="token string">&quot;_context&quot;</span> <span class="token punctuation">:</span> undefined
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)});\n`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 把 catch 补上,在这个例子中没有</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rethrowIfPossible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code <span class="token operator">+=</span> <span class="token string">&quot;} catch(_err) {\n&quot;</span><span class="token punctuation">;</span>
        code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`_hasError</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = true;\n`</span></span><span class="token punctuation">;</span>
        code <span class="token operator">+=</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token string">&quot;_err&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        code <span class="token operator">+=</span> <span class="token string">&quot;}\n&quot;</span><span class="token punctuation">;</span>
        code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`if(!_hasError</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) {\n`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 有onResult 就把结果给传递出去. 目前没有</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code <span class="token operator">+=</span> <span class="token function">onResult</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_result</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 有onDone() 就调用他开始递归,还记得上面的next(i+1) 吗?</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onDone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code <span class="token operator">+=</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 这里是不上上面的if的大括号,在这个例子中没有,所以这里也不执行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rethrowIfPossible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code <span class="token operator">+=</span> <span class="token string">&quot;}\n&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 同步情况下, 这里最终的代码就是</span>
      <span class="token comment">// var _tap0 = _taps[0];</span>
      <span class="token comment">// _interceptors[0].tap(_tap0);</span>
      <span class="token comment">// var _fn0 = _x[0];</span>
      <span class="token comment">// _fn0(options);</span>
      <span class="token comment">// 可以看到,这里会递归下去</span>
      <span class="token comment">// 因为我们tap了4个钩子</span>
      <span class="token comment">// 所以这里会从复4次</span>
      <span class="token comment">// 最终长这样</span>
      <span class="token comment">// var _tap0 = _taps[0];</span>
      <span class="token comment">// _interceptors[0].tap(_tap0);</span>
      <span class="token comment">// var _fn0 = _x[0];</span>
      <span class="token comment">// _fn0(options);</span>
      <span class="token comment">// var _tap1 = _taps[1];</span>
      <span class="token comment">// _interceptors[1].tap(_tap1);</span>
      <span class="token comment">// var _fn1 = _x[1];</span>
      <span class="token comment">// _fn1(options);</span>
      <span class="token comment">// ......</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">:</span>
      <span class="token keyword">let</span> cbCode <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onResult<span class="token punctuation">)</span> cbCode <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`(_err</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, _result</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) =&gt; {\n`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> cbCode <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`_err</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> =&gt; {\n`</span></span><span class="token punctuation">;</span>
      cbCode <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`if(_err</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) {\n`</span></span><span class="token punctuation">;</span>
      cbCode <span class="token operator">+=</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_err</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cbCode <span class="token operator">+=</span> <span class="token string">&quot;} else {\n&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbCode <span class="token operator">+=</span> <span class="token function">onResult</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_result</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onDone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbCode <span class="token operator">+=</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      cbCode <span class="token operator">+=</span> <span class="token string">&quot;}\n&quot;</span><span class="token punctuation">;</span>
      cbCode <span class="token operator">+=</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`_fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        before<span class="token punctuation">:</span> tap<span class="token punctuation">.</span>context <span class="token operator">?</span> <span class="token string">&quot;_context&quot;</span> <span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
        after<span class="token punctuation">:</span> cbCode
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)});\n`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">:</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`var _hasResult</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = false;\n`</span></span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`var _promise</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = _fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        before<span class="token punctuation">:</span> tap<span class="token punctuation">.</span>context <span class="token operator">?</span> <span class="token string">&quot;_context&quot;</span> <span class="token punctuation">:</span> undefined
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)});\n`</span></span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`if (!_promise</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> || !_promise</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.then)\n`</span></span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`  throw new Error('Tap function (tapPromise) did not return promise (returned ' + _promise</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> + ')');\n`</span></span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`_promise</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.then(_result</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> =&gt; {\n`</span></span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`_hasResult</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = true;\n`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code <span class="token operator">+=</span> <span class="token function">onResult</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_result</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onDone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        code <span class="token operator">+=</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`}, _err</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> =&gt; {\n`</span></span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`if(_hasResult</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) throw _err</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_err</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tapIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token string">&quot;});\n&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br></div></div><p>好了, 到了这里 我们可以把compile 出来的call 方法输出出来了</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _taps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _interterceptors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">;</span>
<span class="token comment">// 我们只有一个拦截器所以下面的只会生成一个</span>
  _interceptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> _tap0 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  _interceptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn0</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _tap1 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  _interceptors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn1</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _tap2 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  _interceptors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn2</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _tap3 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  _interceptors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn3 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn3</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>到了这里可以知道,我们的例子中<code>h1.call()</code>其实调用的就是这个方法.到此我们可以说是知道了这个库的百分之80了.</p> <p>不知道大家有没有发现,这个生成的函数的参数列表是从哪里来的呢?往回翻到create()方法里面调用的<code>this.args()</code>你就会看见,没错就是this._args. 这个东西在哪里初始化呢? 翻一下就知道,这是在<code>Hook.js</code>这个类里面初始化的,也就是说你<code>h1 = new xxxHook(['options'])</code> 的时候传入的数组有几个值,那么你<code>h1.call({name: 'haha'})</code> 就能传几个值.看教程的时候他说,这里传入的是一个参数名字的字符串列表,那时候我就纳闷,什么鬼,我传入的不是值吗,怎么就变成了参数名称,现在完全掌握....</p> <p>好了,最简单的<code>SyncHook</code> 已经搞掂,但是一看<code>tapable</code>内部核心使用的钩子却不是他,而是<code>SyncBailHook</code>,在教程中我们已经知道,<code>bail</code>是只要有一个钩子执行完了,并且返回一个值,那么其他的钩子就不执行.我们来看看他是怎么实现的.</p> <p>从刚才我们弄明白的<code>synchook</code>,我们知道了他的套路,其实生成的函数的<code>header()</code>都是一样的,这次我们直接来看看<code>bailhook</code>实现的<code>content()</code>方法,</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 看回callTapsSeries 就知道这里传入的next 是 done</span>
    onResult<span class="token punctuation">:</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> result<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token template-string"><span class="token string">`if(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> !== undefined) {\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">onResult</span><span class="token punctuation">(</span>
        result
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n} else {\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}\n`</span></span><span class="token punctuation">,</span>
    onDone<span class="token punctuation">,</span>
    rethrowIfPossible
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>看出来了哪里不一样吗? 是的<code>bailhook</code>的 <code>callTapsSeries</code>传了<code>onResult</code>属性,我们来看看他这个onResult是啥黑科技</p> <p>父类传的<code>onResult</code>默认是 <code>(result) =&gt; 'return ${result}'</code>,那么他这里返回的就是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">// 下面返回的是字符串,</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>xxx <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里说明,只要有返回值(因为不返回默认是undefined),就会立即return;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// next(); 这里返回的是一个字符串(因为要生成字符串代码)</span>
  <span class="token comment">// 我在上面的注释中提到了 next 是 done 就是那个开启递归的门</span>
  <span class="token comment">// 所以如果tap 一直没返回值, 这里就会一直 if...else.. 的嵌套下去</span>
  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>回头想想,我们刚刚是不是分析了<code>capTap()</code>,如果我们传了<code>onResult</code> 会怎样? 如果你还记得就知道,如果有传了<code>onResult</code>这个回调,他就会接收这个返回值.并且会调用这个回调把<code>result</code>传出去.</p> <p>而且还要注意的是,<code>onDone</code>在<code>callTap()</code>的时候是处理过的,我在贴出来一次.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>onDone<span class="token punctuation">:</span><span class="token operator">!</span>onResult <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是说如果我传了<code>onResult</code> 那么这个<code>onDone</code>就是一个<code>false</code>.</p> <p>所以递归的门现在从<code>sync</code>的<code>onDone</code>,变到<code>syncBail</code>的<code>onResult</code>了</p> <p>好,现在带着这些变化去看<code>this.capTap()</code>,你就能推出现在这个 call 函数会变成这样.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _taps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _interterceptors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">;</span>
<span class="token comment">// 我们只有一个拦截器所以下面的只会生成一个</span>
  _interceptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> _tap0 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  _interceptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _result0 <span class="token operator">=</span> <span class="token function">_fn0</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里说明,只要有返回值(因为不返回默认是undefined),就会立即return;</span>
    <span class="token keyword">return</span> _result0
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _tap1 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _interceptors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _result1 <span class="token operator">=</span> <span class="token function">_fn1</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _result1
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _tap2 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      _interceptors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> _result2 <span class="token operator">=</span> <span class="token function">_fn2</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_result2 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _result2
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> _tap3 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        _interceptors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _fn3 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">_fn3</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>到如今,tapable库 已经删除了 tapable文件,只留下了钩子文件.但不影响功能,webpack 里的<code>compile</code> <code>compilation</code> 等一众重要插件,都是基于 tapable中的这些钩子.</p> <p>所以我解析这个tapable也没有意义了.</p> <p>到此,关于tapable的大部分我都解剖了一遍,还有其他类型的<code>hook</code> 如果你们愿意,相信你们去研究一下,也能够游刃有余.</p> <p>那个,写得有些随性,可能会让你们觉得模糊,但是...我写作新手,尽力了,不懂就在那个评论区问我.我看到会回复的.共勉.</p> <h2 id="后记"><a href="#后记" aria-hidden="true" class="header-anchor">#</a> 后记</h2> <p>本来以为会很难,但是越往下深入的时候发现,大神之所以成为大神,不是他的代码写得牛,是他的思维牛,没有看不懂的代码,只有跟不上的思路,要看懂他如何把call 函数组织出来不难,难的是,他居然能想到这样来生成函数,还可以考虑到,拦截器钩子,和<code>context</code> 属性,以及他的 <code>onResult</code> <code>onDone</code> 回调的判断,架构的设计,等等,一步接一步.先膜拜吧...</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/les-lee/origin-blog/edit/master/blog/webpack/tapable.md" target="_blank" rel="noopener noreferrer">有错请在这里指正</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最近更新时间: </span> <span class="time">2/8/2019, 5:13:15 PM</span></div></div> <!----> </div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1e3fcec8.js" defer></script><script src="/assets/js/10.8edc7d77.js" defer></script><script src="/assets/js/2.4778334a.js" defer></script><script src="/assets/js/1.cb8c6553.js" defer></script><script src="/assets/js/19.4691e707.js" defer></script>
  </body>
</html>
